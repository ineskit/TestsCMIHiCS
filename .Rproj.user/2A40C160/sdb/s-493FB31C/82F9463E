{
    "collab_server" : "",
    "contents" : "library(subcon)\nlibrary(data.table)\nlibrary(foreign)\nlibrary(doSNOW)\nlibrary(dplyr)\n\nLog <- function(text, ...) {\n  msg <- sprintf(paste0(as.character(Sys.time()), \": \", text, \"\\n\"), ...)\n  cat(msg)\n}\n\nimportData <- function(inputPath, fileName){\n  if(grepl(\".csv\", fileName)){\n    dataset_labeled <- fread(paste0(inputPath, \"/\", fileName))\n  }else{\n    dataset_labeled <- as.data.table(read.arff(paste0(inputPath,\"/\", fileName)))\n  }\n  if(\"id\" %in% names(dataset_labeled)){\n    dataset_labeled <- dataset_labeled[,!\"id\", with=F]\n  }\n  if(\"outlier\" %in% names(dataset_labeled)) {\n    names(dataset_labeled)[which(names(dataset_labeled)==\"outlier\")] <- \"class\"\n  }\n  if(!(\"class\" %in% names(dataset_labeled))) {\n    names(dataset_labeled)[ncol(dataset_labeled)] <- \"class\"\n  }\n  if(\"yes\" %in% levels(dataset_labeled$class)){\n    dataset_labeled$class <- as.numeric(dataset_labeled$class == \"yes\")\n  }else{\n    if(is.factor(dataset_labeled$class)){\n      dataset_labeled$class <- as.numeric(levels(dataset_labeled$class))[dataset_labeled$class]\n    }\n    dataset_labeled[,class:=ifelse(class>0, 1, 0),]\n  }\n  dataset_labeled\n}\n\nrunLOF <- function(subspaces, data, minPts){\n  lapply(subspaces, function(x) {\n    tmp <- LOF(data[,unlist(x), with=F], k = minPts)\n    tmp[!is.finite(tmp)] <- 1\n    return(tmp)\n  })\n}\n\napplyLOF <- function(outputSpaces, data, label, maxMinPts, input, algorithm){\n  tmpResult <- foreach(k = seq(10, min(nrow(data) - 1, maxMinPts), by= 10)) %do% {\n    Log(paste0(\"input: \", input, \" algorithm: \", algorithm, \" k: \", k))\n    # outlier detection\n    uniqueOutputSpaces <- unique(lapply(outputSpaces, sort)) # remove exact duplicate subspaces\n    lofactors <- runLOF(subspaces = uniqueOutputSpaces, data = data, minPts = k)\n\n    # summarize the number of subspaces that hold the max score for an object\n    numberMaxScoreSubspaces <- data.table(matrix(unlist(lofactors), ncol=length(label), byrow = T)) %>%\n      summarize_all(which.max) %>%\n      as.numeric %>%\n      unique %>%\n      length\n\n    finalScoreMax <- Reduce(maxCombination, lofactors)\n    finalScoreSum <- Reduce(sumCombination, lapply(lofactors, identity))\n\n    # evaluation\n    # auc_sum <- combinedScoreAUC(combinationFun = sumCombination, scores = lofactors, label = label)\n    # auc_max <- combinedScoreAUC(combinationFun = maxCombination, scores = lofactors, label = label)\n\n    Rprecision_adj_sum <- precisionAtN(label, finalScoreSum, n = sum(label), adjusted = T)\n    Rprecision_adj_max <- precisionAtN(label, finalScoreMax, n = sum(label), adjusted = T)\n\n    auc_sum <- redundancyAUC(scores = lofactors, label = label, combinationFun = sumCombination, scaleFun = identity)\n    auc_max <- redundancyAUC(scores = lofactors, label = label, combinationFun = maxCombination, scaleFun = identity)\n\n    data.table(\"AUC_sum\" = auc_sum$initialAUC,\n               \"Rprecision_adj_sum\" = Rprecision_adj_sum,\n               \"numberRemainingSpaces_sum\" = auc_sum$numberRemainingSpaces,\n               \"AUC_removedRedundant_sum\" = auc_sum$maximumAUC,\n\n               \"AUC_max\" = auc_max$initialAUC,\n               \"Rprecision_adj_max\" = Rprecision_adj_max,\n               \"numberRemainingSpaces_max\" = auc_max$numberRemainingSpaces,\n               \"AUC_removedRedundant_max\" = auc_max$maximumAUC,\n\n               \"totalNumberSubspaces\" = length(uniqueOutputSpaces),\n               \"numberMaxScoreSubspaces\" = numberMaxScoreSubspaces,\n               \"minPts\" = k)\n  }\n\n  data.table(Reduce(rbind, tmpResult))\n}\n\nsubspaceSearch <- function(data, alpha, numRuns, algorithm, topkSearch, topkOutput){\n  sampleSize <- 1000\n  if(nrow(data)>sampleSize){\n    sampledata <- data[sample(.N, sampleSize)]\n    Log(paste0(\"Data set has \", nrow(data),\" rows. Sampling down to \", sampleSize, \" rows.\"))\n  }\n  else{\n    sampledata <- data\n  }\n  indexMatrix <- sortedIndexMatrix(sampledata)\n  numMatrix <- data.matrix(data)\n\n  addTrivialSpaces <- function(subspaces, numDim){\n    subspaces[[length(subspaces) + 1]] <- c(1:numDim) # add full space\n    subspaces <- c(subspaces, 1:numDim) # add single dimensions\n    subspaces\n  }\n\n  resList <- list()\n  switch(algorithm,\n         GMD = {\n           resList$outputSpaces <- GMD(indexMap = indexMatrix, alpha, numRuns)\n         },\n         HiCS = {\n           capture.output(hicsSearchResult <- HiCSSearch(indexMap = indexMatrix, alpha, numRuns, topkSearch = topkSearch, topkOutput = topkOutput), file = NULL)\n\n           resList$outputSpaces <- hicsSearchResult$subspaces\n           resList$contrast     <- hicsSearchResult$contrast\n         },\n         FS = {\n           outputSpaces <- list(1:ncol(sampledata))\n         },\n         HiCSSO = {\n           capture.output(hicsSearchResult <- HiCSSearch(indexMap = indexMatrix, alpha, numRuns, topkSearch = topkSearch, topkOutput = topkOutput), file = NULL)\n           outputSpaces <- hicsSearchResult$subspaces\n           outputSpaces <- addTrivialSpaces(outputSpaces, ncol(sampledata))\n           contrast     <- hicsSearchResult$contrast\n         },\n         GMDSO = {\n           outputSpaces <- GMD(indexMap = indexMatrix, alpha, numRuns)\n           outputSpaces <- addTrivialSpaces(outputSpaces, ncol(sampledata))\n         },\n         CMI = {\n           CMIResult = CMISearch(data = numMatrix, numCluster = 10, topkSearch = topkSearch, topkOutput = topkOutput)\n           resList$outputSpaces <- CMIResult$subspaces\n           resList$contrast     <- CMIResult$contrast\n         }\n  )\n  Log(paste0(algorithm, \": found \", length(resList$outputSpaces), \" subspaces.\"))\n  return (resList)\n}\n\nrunExperiments <- function(inputPath,\n                           outputFolder=\"results\",\n                           outputFile=\"experimentResult.RData\",\n                           numCores = 1,\n                           alpha = 0.1,\n                           numRuns = 100,\n                           maxMinPts = 100,\n                           logFile=\"\",\n                           topkSearch = 500,\n                           topkOutput = 100){\n\n  # setup\n  Log(\"starting experiments\")\n  inputs <- list.files(path=inputPath, recursive = T)\n   algorithms <- c(\"HiCS\", \"CMI\", \"GMD\")\n\n\n  experiments <- expand.grid(\"algorithm\" = algorithms, \"input\" = inputs, stringsAsFactors = FALSE)\n\n  resultSet <- data.table()\n\n  if(numCores > 1){\n    Log(paste0(\"setting up parallel cluster with \", numCores, \" cores...\"))\n    cluster <- makeCluster(numCores, type = \"SOCK\", outfile=logFile)\n    registerDoSNOW(cluster)\n  }else{\n    Log(paste0(\"running in sequential mode...\"))\n    registerDoSEQ()\n  }\n\n  t0 <- proc.time()\n\n  parallelResult <- foreach(i=1:nrow(experiments),\n                            .packages=c(\"foreign\", \"data.table\", \"subcon\", \"foreach\", \"dplyr\"),\n                            .export=c(\"subspaceSearch\", \"applyLOF\", \"runLOF\", \"Log\", \"importData\")) %do% {\n\n                              experiment <- experiments[i,]\n\n                              dataset_labeled <- importData(inputPath, experiment$input)\n                              dt <- data.table(dataset_labeled)\n                              label <- dt$class\n                              dt <- dt[,-c(\"class\"), with=F]\n\n                              timer_start <- proc.time()\n                              rL <- subspaceSearch(data = dt, alpha, numRuns, algorithm = experiment$algorithm, topkSearch, topkOutput)\n                              timer_end <- proc.time()\n\n                              timer_start_LOF <- proc.time()\n                              result <- applyLOF(outputSpaces = rL$outputSpaces, data=dt, label=label, maxMinPts = maxMinPts, input = experiment$input, algorithm = experiment$algorithm)\n                              timer_end_LOF <- proc.time()\n\n                              # for (i in 1:5) {\n                              #   subspX <- sapply(outputSpaces[i], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              #   header<-paste0(\"Top_\",i)\n                              #   top5SS$header <- subspX\n                              #   #top5SS <- data.table(header = subspX)\n                              # }\n                              subsp1 <- sapply(rL$outputSpaces[1], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp2 <- sapply(rL$outputSpaces[2], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp3 <- sapply(rL$outputSpaces[3], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp4 <- sapply(rL$outputSpaces[4], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp5 <- sapply(rL$outputSpaces[5], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp6 <- sapply(rL$outputSpaces[6], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp7 <- sapply(rL$outputSpaces[7], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp8 <- sapply(rL$outputSpaces[8], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp9 <- sapply(rL$outputSpaces[9], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp10 <- sapply(rL$outputSpaces[10], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp11 <- sapply(rL$outputSpaces[11], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp12 <- sapply(rL$outputSpaces[12], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp13 <- sapply(rL$outputSpaces[13], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp14 <- sapply(rL$outputSpaces[14], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp15 <- sapply(rL$outputSpaces[15], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp16 <- sapply(rL$outputSpaces[16], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp17 <- sapply(rL$outputSpaces[17], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp18 <- sapply(rL$outputSpaces[18], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp19 <- sapply(rL$outputSpaces[19], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              subsp20 <- sapply(rL$outputSpaces[20], function(x) paste0(\"[\",paste(x, collapse = \",\"),\"]\"))\n                              top20SS <- data.table(subsp1, subsp2, subsp3, subsp4, subsp5, subsp6, subsp7, subsp8, subsp9, subsp10,\n                                                   subsp11, subsp12, subsp13, subsp14, subsp15, subsp16, subsp17, subsp18, subsp19, subsp20)\n                        \n                              subsp1V <- rL$outputSpaces[1]\n                              subsp2V <- rL$outputSpaces[2]\n                              subsp3V <- rL$outputSpaces[3]\n                              subsp4V <- rL$outputSpaces[4]\n                              subsp5V <- rL$outputSpaces[5]\n                              subsp6V <- rL$outputSpaces[6]\n                              subsp7V <- rL$outputSpaces[7]\n                              subsp8V <- rL$outputSpaces[8]\n                              subsp9V <- rL$outputSpaces[9]\n                              subsp10V <- rL$outputSpaces[10]\n                              subsp11V <- rL$outputSpaces[11]\n                              subsp12V <- rL$outputSpaces[12]\n                              subsp13V <- rL$outputSpaces[13]\n                              subsp14V <- rL$outputSpaces[14]\n                              subsp15V <- rL$outputSpaces[15]\n                              subsp16V <- rL$outputSpaces[16]\n                              subsp17V <- rL$outputSpaces[17]\n                              subsp18V <- rL$outputSpaces[18]\n                              subsp19V <- rL$outputSpaces[19]\n                              subsp20V <- rL$outputSpaces[20]\n\n                              top20SSV <- data.table(subsp1V, subsp2V, subsp3V, subsp4V, subsp5V, subsp6V, subsp7V, subsp8V, subsp9V, subsp10V,\n                                                    subsp11V, subsp12V, subsp13V, subsp14V, subsp15V, subsp16V, subsp17V, subsp18V, subsp19V, subsp20V)\n                             \n                              \n                              if (experiment$algorithm != \"GMD\"){\n                                data.table(cbind(algorithm = experiment$algorithm, dataset = experiment$input, duationSS = (timer_end -timer_start)[\"elapsed\"],\n                                                 durationLOF = (timer_end_LOF - timer_start_LOF)[\"elapsed\"], result, top20SS, top20SSV, Highestcontrast =rL$contrast[1],\n                                                 contrast2 =rL$contrast[2], contrast3 =rL$contrast[3], contrast4 =rL$contrast[4], contrast5 =rL$contrast[5]))\n                              }\n                              else{\n                                data.table(cbind(algorithm = experiment$algorithm, dataset = experiment$input, duationSS = (timer_end -timer_start)[\"elapsed\"],\n                                                 durationLOF = (timer_end_LOF - timer_start_LOF)[\"elapsed\"], result, top20SS, top20SSV, Highestcontrast =\"0\",\n                                                 contrast2 =\"0\", contrast3 =\"0\", contrast4 =\"0\", contrast5 =\"0\"))\n                              }\n                              # top 5 subspaces:\n                              #top5SS<-data.table(cbind(subspaces = outputSpaces[1:5]), contrast = contrastCMI)\n                            }\n\n  combinedResult <- data.table(Reduce(rbind, parallelResult))\n\n  print(paste0(\"total duration experiment: \", (proc.time() - t0)[\"elapsed\"]))\n  # store result\n\n  save(combinedResult, file=paste0(outputFolder,\"/\",outputFile))\n\n  #outputFileEnh <- paste0(outputFile, \"_enh\")\n  #save(top5SS, file=paste0(outputFolder,\"/\",outputFileEnh))\n  # cleanup\n  if(numCores > 1){\n    stopCluster(cluster)\n  }\n  combinedResult\n}\n\n  # finalResult <- runExperiments(inputPath = \"datasets\", maxMinPts = 100, numCores=1, topkSearch = 500, topkOutput = 100)\n  # finalResult <- runExperiments(inputPath = \"datasets\", maxMinPts = 100, numCores=1, topkSearch = 50, topkOutput = 20)\n\n",
    "created" : 1479825476619.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "596737236",
    "id" : "82F9463E",
    "lastKnownWriteTime" : 1480407135,
    "last_content_update" : 1480407135456,
    "path" : "D:/Uni/SS16/Hiwi/github/TestsCMIHiCS/HICSvsCMI_Experiments.R",
    "project_path" : "HICSvsCMI_Experiments.R",
    "properties" : {
    },
    "relative_order" : 7,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}